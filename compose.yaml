networks:
  app_network:
    driver: bridge

services:
  nginx:
    image: nginx:latest
    container_name: nginx
    ports:
      - "80:80"
      - "443:443"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      - ./conf.d:/etc/nginx/conf.d
      - ./ssl:/etc/nginx/ssl  # ðŸ”¥ SSL ì¸ì¦ì„œ ì €ìž¥ì†Œ
      - ./ssl-log:/var/log
    depends_on:
      - openWebUI
    environment:
      - DOMAIN=${DOMAIN}
      - EMAIL=${EMAIL}
      - DUCKDNSTOKEN=${DUCKDNSTOKEN}
    command: >
      sh -c '
        # ðŸ”¥ APT íŒ¨í‚¤ì§€ë¥¼ ì´ìš©í•´ Certbot ë° cron ì„¤ì¹˜
        apt update && apt install -y certbot python3-venv cron;

        # ðŸ”¥ Python ê°€ìƒí™˜ê²½ ìƒì„± í›„ certbot ë° í”ŒëŸ¬ê·¸ì¸ ì„¤ì¹˜
        python3 -m venv /opt/certbot-env;
        /opt/certbot-env/bin/pip install --upgrade pip;
        /opt/certbot-env/bin/pip install certbot certbot-dns-duckdns;

        # ðŸ”¥ Certbotì´ í”ŒëŸ¬ê·¸ì¸ì„ ì¸ì‹í•˜ëŠ”ì§€ í™•ì¸
        /opt/certbot-env/bin/certbot plugins;

        # ðŸ”¥ SSL ë””ë ‰í† ë¦¬ ë° Nginx ë¡œê·¸ ë””ë ‰í† ë¦¬ ìƒì„±
        mkdir -p /etc/nginx/ssl/live/${DOMAIN};
        mkdir -p /var/log/nginx;

        # ðŸ”¥ DuckDNS API í† í° ì €ìž¥
        echo "dns_duckdns_token = ${DUCKDNSTOKEN}" > /etc/nginx/ssl/duckdns.ini;
        chmod 600 /etc/nginx/ssl/duckdns.ini;

        # ðŸ”¥ SSL ì¸ì¦ì„œ ë°œê¸‰ (ì—†ì„ ê²½ìš°)
        echo "Requesting SSL certificate...";
        /opt/certbot-env/bin/certbot certonly \
          --non-interactive --agree-tos \
          --email ${EMAIL} \
          --authenticator dns-duckdns \
          --dns-duckdns-credentials /etc/nginx/ssl/duckdns.ini \
          --dns-duckdns-propagation-seconds 30 \
          -d ${DOMAIN} -d *.${DOMAIN} \
          --config-dir /etc/nginx/ssl \
          --logs-dir /var/log/letsencrypt \
          --work-dir /var/lib/letsencrypt;

        # ðŸ”¥ cronì— SSL ìžë™ ê°±ì‹  ë“±ë¡ (ë§¤ì¼ ì˜¤ì „ 3ì‹œ ì‹¤í–‰)
        echo "0 3 * * * /opt/certbot-env/bin/certbot renew --quiet --config-dir /etc/nginx/ssl --post-hook \"nginx -s reload\"" > /etc/crontab;
        crontab /etc/crontab;
        service cron start;

        echo "Starting Nginx...";
        exec nginx -g "daemon off;";
      '
    networks:
      - app_network

  openWebUI:
    container_name: open-webui
    image: ghcr.io/open-webui/open-webui:main
    restart: always
    # ports:
    #   - "3000:8080"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      - ollama
    environment:
      - OLLAMA_BASE_URL=http://ollama:11434
    volumes:
      - open-webui:/app/backend/data
    networks:
      - app_network

  ollama:
    container_name: ollama
    image: ollama/ollama
    deploy:
      resources:
        reservations:
          devices:
            - capabilities: [gpu]
    ports:
      - "11434:11434"
    volumes:
      - ollama:/root/.ollama
    networks:
      - app_network

volumes:
  ollama:
    external: true
  open-webui:
    external: true
